# 导出格式 FBX/GLB 回归复盘（2026-02-27）

## 背景
在现有导出流程上新增了导出格式切换（`FBX/GLB`，默认 `FBX`）。目标是保持原有筛选与命名逻辑不变，仅在最终导出后缀和导出器上切换。

## 现象
1. 首次导出时报错：`ValueError: too many values to unpack (expected 6)`（`export.py` 第 157 行附近）。
2. 修复后可执行，但在存在 collection + mesh 的场景下，仍提示“`No available collection for export`”。

## 根因分析
### 根因 1：Collection 分组接口发生了返回结构变化
- 旧逻辑假设 `Collection.sort_hst_types()` 返回 6 元组。
- 现实现返回 `dict`（含 `bake/decal/prop/sm/skm/rig/other`）。
- 导致旧解包语句直接抛错。

### 根因 2：`other` 分组未纳入导出候选
- 修完解包后，导出逻辑仍只拼接 `bake/decal/prop/sm`。
- 未标记或旧标记 collection 被归入 `other`，即使有 mesh 也不会进入导出目标列表。
- 最终触发“无可导出 collection”的误报。

## 处理方案
1. 在 `export.py` 中增加兼容层，统一解析 `sort_hst_types` 返回值（兼容 `dict/tuple`）。
2. 将 `other` 合并到 `sm`（去重），确保未标记/旧标记 collection 可作为静态网格导出候选。
3. 抽出格式分发函数，统一管理 `ext + exporter` 选择，减少分支重复。
4. 在 `common_functions.py` 的 `GLBExport` 中抽出 `_export_selected`，去除重复导出参数。

## 验证
- 执行 `python -m compileall -q .` 通过。
- Blender 手测结果：
  - `FBX` 导出正常。
  - `GLB` 导出正常。
  - 原先两类报错均消失。

## 经验与改进
1. 业务层调用工具函数时，不要假设返回结构恒定，应在边界层做兼容解析。
2. 分类逻辑新增 `other` 时，必须明确“是否可导出”的业务策略，避免静默丢失。
3. 涉及格式扩展（FBX/GLB）时，优先做“流程不变 + 出口切换”，降低回归面。
4. 对关键筛选链路增加可选调试日志（可后续增加开关），加快定位“为什么没导出”。
